<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <title>Barras simples</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h2>Alguma interação</h2>
      </div>
      <div class="row">
        <p>
           Para reordenar os pontos, é preciso redesenhá-los.
        </p>
        <p>
          O objetivo desse exemplo é demonstrar como alterar os elementos SVG da visualização a partir de botões e sobrevoo (hover) com o mouse.
        </p>
      </div>
      <div class="row">
        <h3>Unidade Acadêmica</h3>
        <br>
        <div class="row mychart" id="chart">
        <div id="controls" />
      </div>
      </div>
    </div>

    <style>
      .mychart rect {
        fill: #5A0B4D;
      }

      .mychart text {
        font: 11px sans-serif;
        text-anchor: end;
        color: grey;
      }

    </style>

    <script type="text/javascript">
      // "use strict"

      // definicoes de altura e largura do svg e da vis dentro
      var alturaSVG = 400, larguraSVG = 300;
      var	margin = {top: 10, right: 20, bottom:10, left: 30},
          larguraVis = larguraSVG - margin.left - margin.right,
          alturaVis = alturaSVG - margin.top - margin.bottom,
          larguraTexto = 120, larguraMaxBarras = larguraVis - larguraTexto;

      var grafico = d3.select('#chart') // cria elemento <svg> com um <g> dentro
                      .append('svg')
                        .attr('width', larguraVis + margin.left + margin.right)
                        .attr('height', alturaVis + margin.top + margin.bottom)
                      .append('g')
                        .attr('transform', 'translate(' +  margin.left + ',' + margin.top + ')')

                        xx = null

      function criaVisGeral(campoParaOrdenar, isRedesenho){
        d3.csv("https://raw.githubusercontent.com/nazareno/tamanhos-da-ufcg/master/ufcg_uas_com_matriculas.csv",
               lido => (desenhaVis(lido, campoParaOrdenar, isRedesenho)));

        function desenhaVis(dados, campoParaOrdenar, isRedesenho){
          console.log("Criando para " + campoParaOrdenar)
          dados = dados.filter(d => d.CAMPUS == 1)
                       .map(function(d){
                              return {nome_curto : d.UORG_LOTACAO.substring(18, 40),
                                      Matrículas : +d.MATRICULAS,
                                      "Idade mediana" : +d.idade_mediana,
                                      "Professores 40h": +d["Professor 40h ou DE"],
                                      "Servidores tec/adm": +d.Outro
                                      }
                            })
                       .sort((a, b) => a[campoParaOrdenar] - b[campoParaOrdenar])

          var y = d3.scaleBand()
                     .domain(dados.map(d => d.nome_curto))
                     .rangeRound([alturaVis, 0])
                     .padding(.25);

          var escalaLargura = d3.scaleLinear()
                    .domain([0, d3.max(dados, d => d[campoParaOrdenar])])
                    .rangeRound([0, larguraMaxBarras]);

          var barras = grafico.selectAll("rect")
          var textos = grafico.selectAll("text")
          barras
            .data(dados)
            .enter()
            .append("rect")
              .attr("x", larguraTexto)
              .attr("width", d => escalaLargura(d[campoParaOrdenar]))
              .attr("y", d => y(d.nome_curto))
              .attr("height", y.bandwidth())
              .attr("class", "depto")

          textos
            .data(dados)
            .enter()
            .append("text")
            .attr("y", d => y(d.nome_curto) + y.bandwidth()/2 + 2)
            .attr("x", larguraTexto - 10)
            .text(d => d.nome_curto)

          grafico.selectAll("rect").on("mouseover", mouseNoCirculo);
          function mouseNoCirculo(d){
            d3.selectAll("text")
              .style("font-weight",
                      p => p.nome_curto === d.nome_curto ? "bold" : "normal");
          }

          grafico.selectAll("rect").on("mouseout", mouseSaiuCirculo);
          function mouseSaiuCirculo(d){
            d3.selectAll("text")
              .style("font-weight", "normal");
          }

          const dataKeys = Object.keys(dados[0])
            .filter(d => d !== "UORG_LOTACAO" && d !== "Outro" && d !== "COD_SETOR" && d !== "CAMPUS" && d !== "nome_curto")

          d3.select("#controls").selectAll("button.teams")
            .data(dataKeys)
            .enter()
              .append("button")
              .attr("class", "btn-default")
              .on("click", mudaDimensaoEReordena)
              .html(d => d);

          function mudaDimensaoEReordena(dimensao) {
            dados.sort((a, b) => d3.ascending(a[dimensao], b[dimensao]))
            y.domain(dados.map(d => d.nome_curto))

            var maxValue = d3.max(dados, d => parseFloat(d[dimensao]))

            escalaLargura = escalaLargura.domain([0, maxValue])

            grafico.selectAll("rect")
              .sort((a, b) => b[dimensao] - a[dimensao])
              .transition().duration(300).delay((d,i) => i * 20)
              .attr("width", d => escalaLargura(d[dimensao]))

          }

            // Exercícios:
            // 1 - Adicione uma escala de cores que mude também com a dimensão escolhida
            // 2 - Faça com que retângulos e texto se reordenem ao mudarmos a dimensão
        }
      }

      criaVisGeral("Matrículas", false)
    </script>
  </body>
</html>
